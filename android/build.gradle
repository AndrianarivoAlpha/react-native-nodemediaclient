// In modern Gradle, the buildscript block is no longer needed here.
// The Android Gradle Plugin version is determined by the root project,
// which prevents version conflicts.

// Helper function to check if the new architecture (Fabric) is enabled.
def isNewArchitectureEnabled() {
  return rootProject.hasProperty("newArchEnabled") && rootProject.getProperty("newArchEnabled") == "true"
}

apply plugin: "com.android.library"

// Apply the React Native Gradle plugin if the new architecture is enabled.
if (isNewArchitectureEnabled()) {
  apply plugin: "com.facebook.react"
}

// Helper function to safely get properties from the root project, with a fallback.
// This allows the main project to override versions for compileSdkVersion, etc.
def getExtOrDefault(name) {
  return rootProject.ext.has(name) ? rootProject.ext.get(name) : project.properties["Nodemediaclient_" + name]
}

def getExtOrIntegerDefault(name) {
    // A slightly safer version that handles both String and Integer types from properties.
    def value = getExtOrDefault(name)
    return value instanceof Integer ? value : value.toInteger()
}

// Helper function to detect if the current AGP version supports the `namespace` property.
// Namespace support was added in AGP 7.3 and is mandatory in AGP 8.0+.
def supportsNamespace() {
  def parsed = com.android.Version.ANDROID_GRADLE_PLUGIN_VERSION.tokenize('.')
  def major = parsed[0].toInteger()
  def minor = parsed[1].toInteger()
  return (major == 7 && minor >= 3) || major >= 8
}

android {
  // Use the namespace property for modern AGP versions to ensure compatibility.
  if (supportsNamespace()) {
    namespace "cn.nodemedia.react_native_nodemediaclient"

    // To prevent a build error from having both a `namespace` in bui   `ld.gradle
    // and a `package` in the manifest, we point to a different manifest file
    // that has the `package` attribute removed.
    sourceSets {
      main {
        manifest.srcFile "src/main/AndroidManifestNew.xml"
      }
    }
  }

  compileSdkVersion getExtOrIntegerDefault("compileSdkVersion")

  defaultConfig {
    minSdkVersion getExtOrIntegerDefault("minSdkVersion")
    targetSdkVersion getExtOrIntegerDefault("targetSdkVersion")
  }

  buildTypes {
    release {
      minifyEnabled false
    }
  }

  lintOptions {
    // Suppresses common compatibility warnings that are not critical for React Native.
    disable "GradleCompatible"
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }
}

// Repositories needed to download this library's dependencies.
repositories {
  mavenCentral()
  google()
  // The NodeMediaClient-Android dependency is hosted on JitPack.
  maven { url 'https://jitpack.io' }
}

// Dependencies required by this library.
dependencies {
  // For RN < 0.71, this will be from the local maven repo.
  // For RN >= 0.71, this is replaced by the correct version by the React Native Gradle Plugin.
  //noinspection GradleDynamicVersion
  implementation "com.facebook.react:react-native:+"

  // The core native Android library for NodeMediaClient.
  implementation 'com.github.NodeMedia:NodeMediaClient-Android:3.2.9'
}